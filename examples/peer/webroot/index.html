<!DOCTYPE html>
<html>
<head>
    <title>Sacrificial-Socket Multihome Backend Example</title>
    <link
            crossorigin="anonymous"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
            integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
            rel="stylesheet"
    >
    <link href="/css/app.css" rel="stylesheet" type="text/css">
</head>
<body>
<style>
    #outgoing {
        width: 600px;
        word-wrap: break-word;
        white-space: normal;
    }
</style>
<form>
    <textarea id="incoming"></textarea>
    <button type="submit">submit</button>
</form>
<pre id="outgoing"></pre>
<video id="video" src=""></video>
<script src="/js/simple-peer.min.js" type="text/javascript"></script>
<script>
    navigator.mediaDevices
        .getUserMedia({
            video: {
                facingMode: true,
            },
            audio: true,
        })
        .then((stream) => {
            let p = new SimplePeer({
                initiator: location.hash === "#1",
                trickle: false,
                stream,
            });
            p.on("error", (err) => console.log("error", err));
            p.on("signal", (data) => {
                console.log("SIGNAL", JSON.stringify(data));
                document.querySelector("#outgoing").textContent =
                    JSON.stringify(data);
            });
            document.querySelector("form").addEventListener("submit", (ev) => {
                ev.preventDefault();
                p.signal(JSON.parse(document.querySelector("#incoming").value));
            });
            p.on("connect", () => {
                console.log("CONNECT");
                p.send("whatever" + Math.random());
            });
            p.on("data", (data) => {
                console.log("data: " + data);
            });
            p.on("stream", function (stream) {
                let video = document.getElementById("video");
                video.srcObject = stream;
                video.play();
            });
        })
        .catch((error) => {
            console.log(error);
        });
</script>
</body>
</html>